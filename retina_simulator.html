<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retinal Phototransduction Simulator</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --bg-elevated: #21262d;
            --border: #30363d;
            --text: #e6edf3;
            --text-dim: #8b949e;
            --text-muted: #6e7681;
            /* === DISTINCT COLOR PALETTE === */
            --cyan: #58a6ff;
            --green: #3fb950;
            --red: #f85149;
            --yellow: #ffd700;
            --purple: #a371f7;
            --orange: #ff8c42;
            --pink: #ec4899;
            --teal: #14b8a6;
            /* Cell type colors */
            --rod: #8b5cf6;
            --cone: #f59e0b;
            /* Plot variable colors - DISTINCT */
            --color-I: #ffd700;      /* I(t) - Gold/Yellow */
            --color-R: #a371f7;      /* R* - Purple */
            --color-E: #ec4899;      /* E* - Pink (was similar to I) */
            --color-G: #3fb950;      /* cGMP - Green */
            --color-C: #f85149;      /* Ca2+ - Red */
            --color-J: #58a6ff;      /* J - Cyan */
            /* Network colors */
            --color-stim: #ffd700;
            --color-rod-avg: #8b5cf6;
            --color-cone-avg: #f59e0b;
            --color-gang-avg: #3fb950;
            --color-photorec-input: #14b8a6;
            --color-h-avg: #6366f1;
            --color-a-avg: #ec4899;
        }
        html, body { height: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            line-height: 1.5;
            font-size: 14px;
        }

        /* === LAYOUT === */
        .app { display: flex; height: 100vh; overflow: hidden; }
        .sidebar {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .main { flex: 1; overflow-y: auto; padding: 16px; }

        /* === SIDEBAR === */
        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            text-align: center;
        }
        .sidebar-header h1 { font-size: 1.1rem; font-weight: 600; }
        .sidebar-header h1 span { color: var(--cyan); }
        .sidebar-header p { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; }

        .ctrl-section { padding: 12px 16px; border-bottom: 1px solid var(--border); }
        .ctrl-section h3 {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ctrl-section h3::before {
            content: '';
            width: 3px;
            height: 10px;
            background: var(--cyan);
            border-radius: 2px;
        }

        .slider-group { margin-bottom: 10px; }
        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 4px;
        }
        .slider-val { color: var(--cyan); font-weight: 600; font-family: monospace; }
        input[type="range"] {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            background: var(--bg-elevated);
            border-radius: 2px;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: var(--cyan);
            border-radius: 50%;
        }

        .btn-row { display: flex; gap: 6px; margin-top: 8px; }
        .btn {
            flex: 1;
            padding: 6px 8px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.65rem;
            font-weight: 500;
            transition: all 0.15s;
        }
        .btn:hover { border-color: var(--cyan); }
        .btn.active { background: var(--cyan); color: var(--bg-dark); border-color: var(--cyan); }

        .accordion { margin-top: 8px; border: 1px solid var(--border); border-radius: 4px; }
        .accordion-head {
            padding: 6px 10px;
            background: var(--bg-elevated);
            cursor: pointer;
            font-size: 0.65rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion-head::after { content: '‚ñº'; font-size: 0.5rem; color: var(--text-muted); }
        .accordion-head.closed::after { content: '‚ñ∫'; }
        .accordion-body { padding: 8px; display: none; }
        .accordion-body.open { display: block; }
        .param-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .param-item { font-size: 0.6rem; }
        .param-item label { color: var(--text-muted); display: block; margin-bottom: 2px; }
        .param-item input { width: 100%; }

        /* === MAIN CONTENT === */
        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .badge {
            background: var(--purple);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.55rem;
            font-weight: 600;
        }

        /* === DUAL DASHBOARD === */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        @media (max-width: 1100px) { .dashboard { grid-template-columns: 1fr; } }

        .cell-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        .cell-card.rod { border-top: 3px solid var(--rod); }
        .cell-card.cone { border-top: 3px solid var(--cone); }
        .cell-head {
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
            font-weight: 600;
        }
        .cell-stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            padding: 6px 10px;
            background: rgba(0,0,0,0.2);
            font-size: 0.6rem;
            text-align: center;
        }
        .stat-val { font-size: 0.8rem; font-weight: 600; font-family: monospace; color: var(--cyan); }
        .stat-lbl { color: var(--text-muted); font-size: 0.55rem; }

        .plots { padding: 8px; }
        .plot-row {
            height: 55px;
            background: rgba(0,0,0,0.25);
            border-radius: 4px;
            margin-bottom: 4px;
            position: relative;
            overflow: hidden;
        }
        .plot-row:last-child { margin-bottom: 0; }
        /* Labels moved to top-right */
        .plot-lbl {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 0.5rem;
            color: var(--text-muted);
            background: rgba(0,0,0,0.6);
            padding: 1px 4px;
            border-radius: 2px;
            z-index: 2;
        }
        .plot-row canvas { width: 100%; height: 100%; display: block; }

        /* === NETWORK === */
        .network-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        .network-head {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
            font-weight: 600;
        }
        .network-body {
            height: 180px;
            position: relative;
            background: radial-gradient(ellipse at center, rgba(88,166,255,0.02) 0%, transparent 70%);
        }
        .network-body canvas { width: 100%; height: 100%; }
        .layer-lbls {
            position: absolute;
            left: 4px;
            top: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            font-size: 0.5rem;
            color: var(--text-muted);
            pointer-events: none;
        }
        .layer-lbl { writing-mode: vertical-rl; transform: rotate(180deg); }

        /* === TRACE TOGGLES === */
        .trace-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border);
            align-items: center;
        }
        .toggle-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 4px;
        }
        .trace-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.6rem;
            cursor: pointer;
            padding: 3px 8px;
            border-radius: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid transparent;
            transition: all 0.15s;
        }
        .trace-toggle:hover {
            background: rgba(255,255,255,0.05);
        }
        .trace-toggle input {
            display: none;
        }
        .trace-toggle input:checked + span {
            color: var(--toggle-color);
        }
        .trace-toggle input:checked ~ span::before,
        .trace-toggle span::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
            background: var(--text-muted);
            transition: all 0.15s;
        }
        .trace-toggle input:checked + span::before {
            background: var(--toggle-color);
            box-shadow: 0 0 6px var(--toggle-color);
        }
        .trace-toggle input:not(:checked) + span {
            color: var(--text-muted);
            text-decoration: line-through;
            opacity: 0.6;
        }

        .pop-plots-grid {
            padding: 8px;
            background: rgba(0,0,0,0.15);
        }
        .pop-plot-combined {
            height: 140px;
            background: rgba(0,0,0,0.25);
            border-radius: 4px;
            position: relative;
        }
        .pop-plot-combined canvas {
            width: 100%;
            height: 100%;
        }

        /* === THEORY MODAL === */
        .theory-btn {
            position: fixed;
            bottom: 60px;
            right: 16px;
            width: 40px;
            height: 40px;
            background: var(--purple);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(163,113,247,0.4);
            z-index: 100;
        }
        .modal-bg {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-bg.show { display: flex; }
        .modal {
            background: var(--bg-card);
            border-radius: 8px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        .modal-head {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-card);
        }
        .modal-head h2 { font-size: 1rem; }
        .modal-close { background: none; border: none; color: var(--text-dim); font-size: 1.2rem; cursor: pointer; }
        .modal-body { padding: 16px; }
        .modal-sec { margin-bottom: 16px; }
        .modal-sec h4 { color: var(--cyan); font-size: 0.8rem; margin-bottom: 6px; }
        .modal-sec p { color: var(--text-dim); font-size: 0.75rem; line-height: 1.6; }
        .eq-box {
            background: rgba(0,0,0,0.3);
            border-left: 3px solid var(--green);
            padding: 8px 12px;
            border-radius: 0 4px 4px 0;
            margin: 8px 0;
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 0.7rem;
            color: var(--green);
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .hl-box {
            background: linear-gradient(135deg, rgba(163,113,247,0.1), rgba(88,166,255,0.1));
            border: 1px solid var(--purple);
            border-radius: 5px;
            padding: 10px;
            margin: 8px 0;
        }
        .hl-box h5 { color: var(--purple); font-size: 0.7rem; margin-bottom: 4px; }
        .hl-box p { font-size: 0.7rem; }

        /* === STATUS BAR === */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 4px 16px;
            display: flex;
            justify-content: space-between;
            font-size: 0.6rem;
            z-index: 50;
        }
        .status-item { display: flex; align-items: center; gap: 4px; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; }
        .status-dot.on { background: var(--green); animation: blink 1s infinite; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
    </style>
</head>
<body>
<div class="app">
    <!-- === SIDEBAR === -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>üî¨ <span>Retinal</span> Simulator</h1>
            <p>Hamer et al. (2005) Model ‚Ä¢ Eqs A8-A12</p>
        </div>

        <!-- Background Intensity -->
        <div class="ctrl-section">
            <h3>Background Intensity (log scale)</h3>
            <div class="slider-group">
                <div class="slider-label">
                    <span>Photoisomerizations (R*/s)</span>
                    <span class="slider-val" id="ibgVal">10</span>
                </div>
                <input type="range" id="ibgSlider" min="0" max="70" value="20">
            </div>
            <div style="display:flex;justify-content:space-between;font-size:0.5rem;color:var(--text-muted);">
                <span>10‚Å∞ Scotopic</span>
                <span>10¬≥ Mesopic</span>
                <span>10‚Å∑ Photopic</span>
            </div>
        </div>

        <!-- Stimulus -->
        <div class="ctrl-section">
            <h3>Transient Stimulus</h3>
            <div class="btn-row">
                <button class="btn" onclick="fireStim('flash')">‚ö° Flash</button>
                <button class="btn" onclick="fireStim('step')">üìä Step</button>
                <button class="btn" onclick="fireStim('ramp')">üìà Ramp</button>
            </div>
            <div class="slider-group" style="margin-top:10px;">
                <div class="slider-label">
                    <span>Stimulus Strength (R*)</span>
                    <span class="slider-val" id="stimVal">500</span>
                </div>
                <input type="range" id="stimSlider" min="10" max="5000" value="500">
            </div>
        </div>

        <!-- Parameters -->
        <div class="ctrl-section">
            <h3>Biophysical Parameters</h3>
            <div class="accordion">
                <div class="accordion-head" onclick="toggleAcc(this)">Rod (Table 1)</div>
                <div class="accordion-body open">
                    <div class="param-grid">
                        <div class="param-item">
                            <label>œÑ_R (s) [0.4]</label>
                            <input type="range" id="rodTauR" min="0.1" max="1.0" value="0.4" step="0.05">
                        </div>
                        <div class="param-item">
                            <label>œÑ_E (s) [2.0]</label>
                            <input type="range" id="rodTauE" min="0.5" max="4.0" value="2.0" step="0.1">
                        </div>
                        <div class="param-item">
                            <label>Œ≤_dark (s‚Åª¬π) [1.2]</label>
                            <input type="range" id="rodBeta" min="0.5" max="3.0" value="1.2" step="0.1">
                        </div>
                        <div class="param-item">
                            <label>Gain [8]</label>
                            <input type="range" id="rodGain" min="1" max="20" value="8" step="1">
                        </div>
                        <div class="param-item">
                            <label>Noise œÉ [0.02]</label>
                            <input type="range" id="rodNoise" min="0" max="0.1" value="0.02" step="0.005">
                        </div>
                    </div>
                </div>
            </div>
            <div class="accordion">
                <div class="accordion-head closed" onclick="toggleAcc(this)">Cone (‚âà20√ó faster)</div>
                <div class="accordion-body">
                    <div class="param-grid">
                        <div class="param-item">
                            <label>œÑ_R (s) [0.02]</label>
                            <input type="range" id="coneTauR" min="0.005" max="0.1" value="0.02" step="0.005">
                        </div>
                        <div class="param-item">
                            <label>œÑ_E (s) [0.1]</label>
                            <input type="range" id="coneTauE" min="0.02" max="0.3" value="0.1" step="0.01">
                        </div>
                        <div class="param-item">
                            <label>Noise œÉ [0.05]</label>
                            <input type="range" id="coneNoise" min="0" max="0.2" value="0.05" step="0.01">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simulation -->
        <div class="ctrl-section">
            <h3>Simulation Control</h3>
            <div class="btn-row">
                <button class="btn active" id="btnRun" onclick="toggleSim()">‚ñ∂ Run</button>
                <button class="btn" onclick="resetSim()">‚Ü∫ Reset</button>
            </div>
        </div>
    </aside>

    <!-- === MAIN === -->
    <main class="main">
        <div class="section-title">
            <span>Single-Cell Phototransduction</span>
            <span class="badge">Hamer 2005 Eqs A8-A12</span>
        </div>

        <div class="dashboard">
            <!-- ROD -->
            <div class="cell-card rod">
                <div class="cell-head">üåô ROD Photoreceptor</div>
                <div class="cell-stats">
                    <div><div class="stat-val" id="rodR">0.0</div><div class="stat-lbl">R*</div></div>
                    <div><div class="stat-val" id="rodE">0.0</div><div class="stat-lbl">E* (PDE)</div></div>
                    <div><div class="stat-val" id="rodG">4.00</div><div class="stat-lbl">[cGMP] ŒºM</div></div>
                    <div><div class="stat-val" id="rodC">0.60</div><div class="stat-lbl">[Ca¬≤‚Å∫] ŒºM</div></div>
                    <div><div class="stat-val" id="rodJ">-30.0</div><div class="stat-lbl">J (pA)</div></div>
                </div>
                <div class="plots">
                    <div class="plot-row"><span class="plot-lbl" style="color:var(--color-I)">I(t) R*/s</span><canvas id="pRodI"></canvas></div>
                    <div class="plot-row"><span class="plot-lbl" style="color:var(--color-R)">R*</span><canvas id="pRodR"></canvas></div>
                    <div class="plot-row"><span class="plot-lbl" style="color:var(--color-E)">E* (PDE)</span><canvas id="pRodE"></canvas></div>
                    <div class="plot-row"><span class="plot-lbl" style="color:var(--color-G)">[cGMP] ŒºM</span><canvas id="pRodG"></canvas></div>
                    <div class="plot-row"><span class="plot-lbl" style="color:var(--color-C)">[Ca¬≤‚Å∫] ŒºM</span><canvas id="pRodC"></canvas></div>
                    <div class="plot-row"><span class="plot-lbl" style="color:var(--color-J)">J (pA)</span><canvas id="pRodJ"></canvas></div>
                </div>
            </div>

            <!-- CONE -->
            <div class="cell-card cone">
                <div class="cell-head">‚òÄÔ∏è CONE Photoreceptor</div>
                <div class="cell-stats">
                    <div><div class="stat-val" id="coneR">0.0</div><div class="stat-lbl">R*</div></div>
                    <div><div class="stat-val" id="coneE">0.0</div><div class="stat-lbl">E* (PDE)</div></div>
                    <div><div class="stat-val" id="coneG">4.00</div><div class="stat-lbl">[cGMP] ŒºM</div></div>
                    <div><div class="stat-val" id="coneC">0.60</div><div class="stat-lbl">[Ca¬≤‚Å∫] ŒºM</div></div>
                    <div><div class="stat-val" id="coneJ">-8.0</div><div class="stat-lbl">J (pA)</div></div>
                </div>
                <div class="plots">
                    <div class="plot-row"><span class="plot-lbl" style="color:var(--color-I)">I(t) R*/s</span><canvas id="pConeI"></canvas></div>
                    <div class="plot-row"><span class="plot-lbl" style="color:var(--color-R)">R*</span><canvas id="pConeR"></canvas></div>
                    <div class="plot-row"><span class="plot-lbl" style="color:var(--color-E)">E* (PDE)</span><canvas id="pConeE"></canvas></div>
                    <div class="plot-row"><span class="plot-lbl" style="color:var(--color-G)">[cGMP] ŒºM</span><canvas id="pConeG"></canvas></div>
                    <div class="plot-row"><span class="plot-lbl" style="color:var(--color-C)">[Ca¬≤‚Å∫] ŒºM</span><canvas id="pConeC"></canvas></div>
                    <div class="plot-row"><span class="plot-lbl" style="color:var(--color-J)">J (pA)</span><canvas id="pConeJ"></canvas></div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Theory Button -->
<button class="theory-btn" onclick="openModal()">üìö</button>

<!-- Modal -->
<div class="modal-bg" id="modal">
    <div class="modal">
        <div class="modal-head">
            <h2>üìñ Phototransduction Model (Human/Primate Parameters)</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="modal-sec">
                <h4>The Biochemical Cascade</h4>
                <p>Light activates rhodopsin (R*), which catalyzes transducin activation (G*), which activates phosphodiesterase (E*/PDE*). PDE* hydrolyzes cGMP, closing CNG channels and reducing Ca¬≤‚Å∫ influx.</p>
                <div class="eq-box">Light ‚Üí R* ‚Üí G* ‚Üí E* (PDE*) ‚Üí cGMP‚Üì ‚Üí CNG channels close ‚Üí Ca¬≤‚Å∫‚Üì ‚Üí Hyperpolarization</div>
            </div>

            <div class="modal-sec">
                <h4>Equation A8: cGMP Dynamics</h4>
                <div class="eq-box">d[cGMP]/dt = Œ±_max / [1 + (Ca/Kc)^m] - (Œ≤_dark + Œ≤_sub √ó E*) √ó [cGMP]</div>
                <p><strong>Rod Parameters (Hamer 2005):</strong> Œ±_max = 117.13 ŒºM/s, Kc = 0.17 ŒºM, m = 2.5, Œ≤_dark = 1.2/s, Œ≤_sub = 0.1/s</p>
                <p><strong>Cone Parameters (CALIBRATED):</strong> Œ±_max = 217.6 ŒºM/s (steady-state), Œ≤_dark = 5.0/s, Œ≤_sub = 2.0/s per E* (gives 50% at ~100k R*/s)</p>
            </div>

            <div class="modal-sec">
                <h4>Equation A9: Calcium Dynamics</h4>
                <div class="eq-box">d[Ca¬≤‚Å∫]/dt = J_influx √ó (g/g_dark)^n - Œ≥_Ca √ó (Ca - c‚ÇÄ)</div>
                <p><strong>Rod:</strong> Œ≥_Ca = 50/s (œÑ_Ca ‚âà 40-90 ms, Field & Rieke 2002)</p>
                <p><strong>Cone:</strong> Œ≥_Ca = 300/s (œÑ_Ca ‚âà 3 ms, Table 20.1 - enables rapid adaptation)</p>
            </div>

            <div class="modal-sec">
                <h4>Equation A12: Photocurrent</h4>
                <div class="eq-box">J = -J_dark √ó [ (2/(fCa+2)) √ó (g/g_dark)^n + (fCa/(fCa+2)) √ó (Ca-c‚ÇÄ)/(Ca_dark-c‚ÇÄ) ]</div>
                <p><strong>Human/Primate Rods:</strong> J_dark ‚âà 13-20 pA (Kraft 1993, Baylor 1984), fCa ‚âà 0.17</p>
                <p><strong>Primate Cones:</strong> J_dark ‚âà 20-25 pA (Schnapf 1990), fCa ‚âà 0.35 (2√ó more Ca¬≤‚Å∫ current)</p>
            </div>

            <div class="modal-sec">
                <h4>Rod vs Cone Time Constants (Table 20.1 - Primate Data)</h4>
                <p><strong>Rods (mouse/primate):</strong> œÑ_R ‚â§ 80 ms, œÑ_E ‚âà 200 ms (dominant). Integration time ‚âà 300 ms.</p>
                <p><strong>Cones (human ERG, monkey retina):</strong> œÑ_R ‚âà 3-5 ms, œÑ_E ‚âà 9-13 ms, œÑ_Ca ‚âà 3 ms. Integration time ‚âà 20-25 ms.</p>
                <p><em>Reference: Krispel et al. 2006, Van Hateren 2005/2006, Kenkre et al. 2005</em></p>
            </div>

            <div class="modal-sec">
                <h4>‚ö†Ô∏è Cone Parameter Calibration</h4>
                <p>Cone parameters calibrated for literature-consistent operating range:</p>
                <div class="eq-box">From literature (Chapter 20):
  Rod half-saturation: ~500-600 R*/s
  Cone half-saturation: ~100,000-240,000 R*/s (200-400√ó higher)

The 20√ó faster œÑ_R and 20√ó faster œÑ_E automatically shift 
the operating range by ~400√ó.

Calibration:
  Œ±_max = 217.6 ŒºM/s (ensures g_dark = 4.0 ŒºM at steady state)
  Œ≤_sub = 2.0 /s per E* (gives ~50% response at ~100,000 R*/s)</div>
                <p><strong>Result:</strong> Rod 50% at ~500 R*/s, Cone 50% at ~100,000 R*/s</p>
            </div>
        </div>
    </div>
</div>

<!-- Status Bar -->
<div class="status-bar">
    <div class="status-item"><span class="status-dot on" id="simDot"></span><span id="simStat">Running</span></div>
    <div class="status-item">t = <span id="simTime">0.00</span> s</div>
    <div class="status-item">FPS: <span id="simFps">60</span></div>
</div>

<script>
// =============================================================================
// PHOTOTRANSDUCTION MODEL - Hamer et al. (2005) Equations A8-A12
// =============================================================================

let running = true;
let t = 0;
const dt = 0.001; // 1 ms timestep
let frames = 0;
let lastFpsT = performance.now();

// Stimulus state
let Ibg = 10;
let stimStrength = 500;
let stim = { type: 'none', start: -1 };

const HIST = 500;

// === DISTINCT COLORS (matching CSS variables) ===
const COLORS = {
    I: 'rgb(255,215,0)',      // Gold
    R: 'rgb(163,113,247)',    // Purple
    E: 'rgb(236,72,153)',     // Pink
    G: 'rgb(63,185,80)',      // Green
    C: 'rgb(248,81,73)',      // Red
    J: 'rgb(88,166,255)'      // Cyan
};

// =============================================================================
// ROD MODEL - Human/Primate parameters
// Sources: Hamer et al. 2005 Table 1, Baylor et al. 1984 (macaque),
//          Kraft et al. 1993 (human), Table 20.1 (primate compilation)
// =============================================================================
const rod = {
    // Front-end time constants (Table 20.1: œÑR ‚â§ 80 ms, œÑE ‚âà 200 ms for rods)
    tauR: 0.08,      // 80 ms - R* lifetime (Krispel et al. 2006, mouse/primate)
    tauE: 0.20,      // 200 ms - dominant time constant (œÑE > œÑR in rods)
    gain: 8,         // Amplification factor (~250-325 G*/R*, Hamer 2005)
    sigma: 0.015,    // Low noise - rods are quiet for single-photon detection
    
    // Back-end (Hamer 2005 Table 1 - vertebrate rod consensus)
    alphaMax: 117.13,  // ŒºM/s - max cGMP synthesis rate
    Kc: 0.17,          // ŒºM - Ca¬≤‚Å∫ half-saturation for cyclase
    m: 2.5,            // Hill coefficient for Ca¬≤‚Å∫ action on cyclase
    betaDark: 1.2,     // /s - dark cGMP hydrolysis rate
    betaSub: 0.1,      // /s per E* - light-dependent hydrolysis
    gDark: 4.0,        // ŒºM - dark [cGMP] (few ŒºM, ~2-5% channels open)
    ncg: 3,            // Hill coefficient for CNG channel (cooperative binding)
    
    // Calcium (Hamer 2005, Nakatani & Yau 1988)
    cDark: 0.6,        // ŒºM - dark [Ca¬≤‚Å∫] (~0.3-0.7 ŒºM in rods)
    c0: 0.01,          // ŒºM - minimum [Ca¬≤‚Å∫] at full light adaptation
    gammaCa: 50.0,     // /s - Ca¬≤‚Å∫ extrusion rate (œÑCa ‚âà 40-90 ms, Fig 19.14B)
    
    // Current (Baylor et al. 1984: macaque ~20 pA, Kraft 1993: human ~13 pA)
    Jdark: 20.0,       // pA - human/primate dark current (13-20 pA range)
    fCa: 0.17,         // Fraction of current carried by Ca¬≤‚Å∫ (~15-20% in rods)
    
    // State variables (initialize at dark-adapted steady state)
    Rstar: 0, Estar: 0, cGMP: 4.0, Ca: 0.6, J: -20.0,
    hist: { I: [], R: [], E: [], G: [], C: [], J: [] }
};

// =============================================================================
// CONE MODEL - Human/Primate parameters (CALIBRATED)
// Sources: Table 20.1 (human ERG, monkey retina), Van Hateren 2005/2006,
//          Schnapf et al. 1990 (macaque), Kenkre et al. 2005 (human)
// 
// CALIBRATION NOTES:
// - Time constants ~20√ó faster than rods (Table 20.1)
// - Œ±_max adjusted so Œ±(c_dark)/Œ≤_dark = g_dark (steady-state consistency)
// - Œ≤_sub = 2.0 gives ~50% response at ~100,000 R*/s (literature: ~240,000 R*/s)
// - The 200√ó shift from rod (500 R*/s) matches the 20√ó20 = 400√ó from fast œÑ
// =============================================================================
const cone = {
    // Front-end time constants (Table 20.1: œÑR ‚âà 3-5 ms, œÑE ‚âà 9-13 ms)
    tauR: 0.004,     // 4 ms - extremely fast R* shutoff (human/monkey)
    tauE: 0.010,     // 10 ms - fast PDE* inactivation (‚âà20√ó faster than rod)
    gain: 2.5,       // Lower gain prevents saturation in bright light
    sigma: 0.04,     // Higher noise - cones are noisier than rods
    
    // Back-end (CALIBRATED for steady-state consistency and proper response)
    // Steady-state requirement: Œ±(c_dark)/Œ≤_dark = g_dark
    // Œ±(0.5ŒºM) = Œ±_max / (1 + (0.5/0.2)^2.5) = Œ±_max / 10.88
    // For g_dark = 4.0: Œ±_max = 5.0 √ó 4.0 √ó 10.88 = 217.6 ŒºM/s
    alphaMax: 217.6,   // ŒºM/s - CORRECTED for g_dark = 4.0 ŒºM at steady state
    Kc: 0.20,          // ŒºM - slightly higher Ca¬≤‚Å∫ sensitivity
    m: 2.5,            // Hill coefficient (same as rod)
    betaDark: 5.0,     // /s - faster dark hydrolysis (~4√ó rod)
    betaSub: 2.0,      // /s per E* - calibrated for ~50% response at ~100,000 R*/s
    gDark: 4.0,        // ŒºM - dark [cGMP] (similar to rod)
    ncg: 3,            // Hill coefficient for CNG channel
    
    // Calcium (Table 20.1: œÑCa ‚âà 3 ms in cones - extremely fast)
    cDark: 0.5,        // ŒºM - slightly lower dark Ca¬≤‚Å∫ than rod
    c0: 0.01,          // ŒºM - minimum [Ca¬≤‚Å∫]
    gammaCa: 300.0,    // /s - very fast Ca¬≤‚Å∫ extrusion (œÑCa ‚âà 3 ms)
    
    // Current (Schnapf 1990: macaque cones ~20-25 pA, Fig 19.3C)
    Jdark: 24.0,       // pA - primate cone dark current (larger than rod!)
    fCa: 0.35,         // ~35% current carried by Ca¬≤‚Å∫ (2√ó higher than rod)
    
    // State variables
    Rstar: 0, Estar: 0, cGMP: 4.0, Ca: 0.5, J: -24.0,
    hist: { I: [], R: [], E: [], G: [], C: [], J: [] }
};

// =============================================================================
// STIMULUS
// =============================================================================
function getI() {
    let I = Ibg;
    if (stim.type !== 'none' && stim.start >= 0) {
        const dt = t - stim.start;
        if (stim.type === 'flash' && dt >= 0 && dt < 0.02) {
            I += stimStrength / 0.02;
        } else if (stim.type === 'step' && dt >= 0 && dt < 2.0) {
            I += stimStrength;
        } else if (stim.type === 'ramp' && dt >= 0 && dt < 2.0) {
            const rampVal = dt < 1.0 ? dt : (2.0 - dt);
            I += stimStrength * rampVal;
        }
    }
    return I;
}

// =============================================================================
// DIFFERENTIAL EQUATIONS - Hamer 2005 Eqs A8-A12
// =============================================================================
function stepCell(cell, I, dt) {
    // Add noise to input (rod/cone intrinsic noise)
    const noisyI = I + (Math.random() - 0.5) * 2 * cell.sigma * I;
    
    // === FRONT-END ===
    cell.Rstar += (noisyI - cell.Rstar / cell.tauR) * dt;
    cell.Rstar = Math.max(0, cell.Rstar);
    
    cell.Estar += (cell.gain * cell.Rstar - cell.Estar / cell.tauE) * dt;
    cell.Estar = Math.max(0, cell.Estar);
    
    // === BACK-END: Eq A8 - cGMP ===
    const alpha = cell.alphaMax / (1 + Math.pow(cell.Ca / cell.Kc, cell.m));
    const beta = cell.betaDark + cell.betaSub * cell.Estar;
    cell.cGMP += (alpha - beta * cell.cGMP) * dt;
    cell.cGMP = Math.max(0.01, Math.min(20, cell.cGMP));
    
    // === Eq A9 - Calcium ===
    const chanOpen = Math.pow(cell.cGMP / cell.gDark, cell.ncg);
    const influxK = cell.gammaCa * (cell.cDark - cell.c0);
    const influx = influxK * chanOpen;
    const efflux = cell.gammaCa * (cell.Ca - cell.c0);
    cell.Ca += (influx - efflux) * dt;
    cell.Ca = Math.max(cell.c0, Math.min(5, cell.Ca));
    
    // === Eq A12 - Photocurrent ===
    // With correct parameters, chanOpen ‚àà [0,1] and caRatio ‚àà [0,1] naturally
    // No clamping needed - the physics ensures J ‚àà [-Jdark, 0]
    const cngTerm = (2 / (cell.fCa + 2)) * chanOpen;
    const caRatio = (cell.Ca - cell.c0) / (cell.cDark - cell.c0);
    const exchTerm = (cell.fCa / (cell.fCa + 2)) * caRatio;
    cell.J = -cell.Jdark * (cngTerm + exchTerm);
    
    return I;
}

// =============================================================================
// VISUALIZATION
// =============================================================================
const ctx = {};

function initCanvas() {
    const ids = ['pRodI','pRodR','pRodE','pRodG','pRodC','pRodJ',
                 'pConeI','pConeR','pConeE','pConeG','pConeC','pConeJ'];
    ids.forEach(id => {
        const c = document.getElementById(id);
        if (c) {
            ctx[id] = c.getContext('2d');
            resizeC(c);
        }
    });
}

function resizeC(c) {
    const r = c.parentElement.getBoundingClientRect();
    const d = window.devicePixelRatio || 1;
    c.width = r.width * d;
    c.height = r.height * d;
    c.style.width = r.width + 'px';
    c.style.height = r.height + 'px';
    c.getContext('2d').scale(d, d);
}

// === IMPROVED PLOT FUNCTION - Centered traces, no fill ===
function plot(id, data, color, yMin, yMax) {
    const c = ctx[id];
    if (!c || data.length < 2) return;
    const cv = c.canvas;
    const d = window.devicePixelRatio || 1;
    const w = cv.width / d, h = cv.height / d;
    
    c.save();
    c.setTransform(1,0,0,1,0,0);
    c.scale(d,d);
    c.clearRect(0,0,w,h);
    
    // Grid lines
    c.strokeStyle = 'rgba(255,255,255,0.05)';
    c.lineWidth = 1;
    for (let i = 1; i < 4; i++) { 
        c.beginPath(); 
        c.moveTo(0, h*i/4); 
        c.lineTo(w, h*i/4); 
        c.stroke(); 
    }
    
    // Center line (middle reference)
    const yMid = (yMax + yMin) / 2;
    const yMidPx = h - ((yMid - yMin) / (yMax - yMin)) * h;
    c.strokeStyle = 'rgba(255,255,255,0.1)';
    c.setLineDash([2, 2]);
    c.beginPath();
    c.moveTo(0, yMidPx);
    c.lineTo(w, yMidPx);
    c.stroke();
    c.setLineDash([]);
    
    // Y labels (small, on left)
    c.fillStyle = 'rgba(255,255,255,0.3)';
    c.font = '8px sans-serif';
    c.fillText(yMax.toFixed(1), 2, 9);
    c.fillText(yMin.toFixed(1), 2, h - 2);
    
    // === LINE ONLY (no fill) ===
    c.strokeStyle = color;
    c.lineWidth = 1.5;
    c.beginPath();
    let started = false;
    for (let i = 0; i < data.length; i++) {
        const x = (i / (data.length - 1)) * w;
        const val = data[i];
        // Clamp to visible range with padding
        const clampedVal = Math.max(yMin, Math.min(yMax, val));
        const y = h - ((clampedVal - yMin) / (yMax - yMin)) * h;
        // Ensure y is within canvas bounds
        const safeY = Math.max(2, Math.min(h - 2, y));
        
        if (!started) {
            c.moveTo(x, safeY);
            started = true;
        } else {
            c.lineTo(x, safeY);
        }
    }
    c.stroke();
    c.restore();
}

function plotMulti(id, datasets) {
    const c = ctx[id];
    if (!c) return;
    const cv = c.canvas;
    const d = window.devicePixelRatio || 1;
    const w = cv.width / d, h = cv.height / d;
    
    c.save();
    c.setTransform(1,0,0,1,0,0);
    c.scale(d,d);
    c.clearRect(0,0,w,h);
    
    // Grid
    c.strokeStyle = 'rgba(255,255,255,0.05)';
    c.lineWidth = 1;
    for (let i = 1; i < 4; i++) { 
        c.beginPath(); 
        c.moveTo(0, h*i/4); 
        c.lineTo(w, h*i/4); 
        c.stroke(); 
    }
    
    // Plot each dataset
    datasets.forEach(({data, color}) => {
        if (data.length < 2) return;
        c.strokeStyle = color;
        c.lineWidth = 1.5;
        c.beginPath();
        for (let i = 0; i < data.length; i++) {
            const x = (i / (data.length - 1)) * w;
            const y = h - Math.max(0, Math.min(1, data[i])) * h;
            if (i === 0) c.moveTo(x, y);
            else c.lineTo(x, y);
        }
        c.stroke();
    });
    c.restore();
}

function updateUI() {
    document.getElementById('rodR').textContent = rod.Rstar.toFixed(1);
    document.getElementById('rodE').textContent = rod.Estar.toFixed(1);
    document.getElementById('rodG').textContent = rod.cGMP.toFixed(3);
    document.getElementById('rodC').textContent = rod.Ca.toFixed(4);
    document.getElementById('rodJ').textContent = rod.J.toFixed(2);
    
    document.getElementById('coneR').textContent = cone.Rstar.toFixed(1);
    document.getElementById('coneE').textContent = cone.Estar.toFixed(2);
    document.getElementById('coneG').textContent = cone.cGMP.toFixed(3);
    document.getElementById('coneC').textContent = cone.Ca.toFixed(4);
    document.getElementById('coneJ').textContent = cone.J.toFixed(2);
    
    document.getElementById('simTime').textContent = t.toFixed(2);
}

function updatePlots() {
    // Calculate adaptive ranges for better visualization
    const Imax = Math.max(200, ...rod.hist.I, ...cone.hist.I) * 1.1;
    const Rmax = Math.max(10, ...rod.hist.R) * 1.2;
    const Emax = Math.max(5, ...rod.hist.E) * 1.2;
    const cRmax = Math.max(5, ...cone.hist.R) * 1.2;
    const cEmax = Math.max(2, ...cone.hist.E) * 1.2;
    
    // Rod plots with distinct colors
    plot('pRodI', rod.hist.I, COLORS.I, 0, Imax);
    plot('pRodR', rod.hist.R, COLORS.R, 0, Rmax);
    plot('pRodE', rod.hist.E, COLORS.E, 0, Emax);
    plot('pRodG', rod.hist.G, COLORS.G, 0, 6);
    plot('pRodC', rod.hist.C, COLORS.C, 0, 1);
    plot('pRodJ', rod.hist.J, COLORS.J, -35, 0);
    
    // Cone plots with distinct colors
    plot('pConeI', cone.hist.I, COLORS.I, 0, Imax);
    plot('pConeR', cone.hist.R, COLORS.R, 0, cRmax);
    plot('pConeE', cone.hist.E, COLORS.E, 0, cEmax);
    plot('pConeG', cone.hist.G, COLORS.G, 0, 6);
    plot('pConeC', cone.hist.C, COLORS.C, 0, 1);
    plot('pConeJ', cone.hist.J, COLORS.J, -30, 0);
}

// =============================================================================
// MAIN LOOP
// =============================================================================
function loop() {
    if (!running) return;
    
    const steps = 10;
    for (let s = 0; s < steps; s++) {
        const I = getI();
        
        stepCell(rod, I, dt);
        stepCell(cone, I, dt);
        
        if (s === 0) {
            const push = (a, v) => { a.push(v); if (a.length > HIST) a.shift(); };
            
            push(rod.hist.I, I);
            push(rod.hist.R, rod.Rstar);
            push(rod.hist.E, rod.Estar);
            push(rod.hist.G, rod.cGMP);
            push(rod.hist.C, rod.Ca);
            push(rod.hist.J, rod.J);
            
            push(cone.hist.I, I);
            push(cone.hist.R, cone.Rstar);
            push(cone.hist.E, cone.Estar);
            push(cone.hist.G, cone.cGMP);
            push(cone.hist.C, cone.Ca);
            push(cone.hist.J, cone.J);
        }
        
        t += dt;
    }
    
    updateUI();
    updatePlots();
    
    frames++;
    const now = performance.now();
    if (now - lastFpsT > 1000) {
        document.getElementById('simFps').textContent = frames;
        frames = 0;
        lastFpsT = now;
    }
    
    requestAnimationFrame(loop);
}

// =============================================================================
// EVENT HANDLERS
// =============================================================================
function fireStim(type) {
    stim.type = type;
    stim.start = t;
    const dur = type === 'flash' ? 100 : 2500;
    setTimeout(() => { stim.type = 'none'; }, dur);
}

function toggleSim() {
    running = !running;
    const btn = document.getElementById('btnRun');
    if (running) {
        btn.textContent = '‚è∏ Pause';
        btn.classList.add('active');
        document.getElementById('simDot').classList.add('on');
        document.getElementById('simStat').textContent = 'Running';
        loop();
    } else {
        btn.textContent = '‚ñ∂ Run';
        btn.classList.remove('active');
        document.getElementById('simDot').classList.remove('on');
        document.getElementById('simStat').textContent = 'Paused';
    }
}

function resetSim() {
    t = 0;
    stim.type = 'none';
    
    rod.Rstar = 0; rod.Estar = 0; rod.cGMP = rod.gDark; rod.Ca = rod.cDark; rod.J = -rod.Jdark;
    rod.hist = { I: [], R: [], E: [], G: [], C: [], J: [] };
    
    cone.Rstar = 0; cone.Estar = 0; cone.cGMP = cone.gDark; cone.Ca = cone.cDark; cone.J = -cone.Jdark;
    cone.hist = { I: [], R: [], E: [], G: [], C: [], J: [] };
}

function toggleAcc(el) {
    el.classList.toggle('closed');
    el.nextElementSibling.classList.toggle('open');
}

function openModal() { document.getElementById('modal').classList.add('show'); }
function closeModal() { document.getElementById('modal').classList.remove('show'); }

function init() {
    initCanvas();
    
    // Sliders
    document.getElementById('ibgSlider').addEventListener('input', e => {
        Ibg = Math.pow(10, e.target.value / 10);
        document.getElementById('ibgVal').textContent = Ibg < 100 ? Ibg.toFixed(1) : Ibg.toFixed(0);
    });
    document.getElementById('stimSlider').addEventListener('input', e => {
        stimStrength = parseInt(e.target.value);
        document.getElementById('stimVal').textContent = stimStrength;
    });
    
    // Rod params
    document.getElementById('rodTauR')?.addEventListener('input', e => rod.tauR = parseFloat(e.target.value));
    document.getElementById('rodTauE')?.addEventListener('input', e => rod.tauE = parseFloat(e.target.value));
    document.getElementById('rodBeta')?.addEventListener('input', e => rod.betaDark = parseFloat(e.target.value));
    document.getElementById('rodGain')?.addEventListener('input', e => rod.gain = parseFloat(e.target.value));
    document.getElementById('rodNoise')?.addEventListener('input', e => rod.sigma = parseFloat(e.target.value));
    
    // Cone params
    document.getElementById('coneTauR')?.addEventListener('input', e => cone.tauR = parseFloat(e.target.value));
    document.getElementById('coneTauE')?.addEventListener('input', e => cone.tauE = parseFloat(e.target.value));
    document.getElementById('coneNoise')?.addEventListener('input', e => cone.sigma = parseFloat(e.target.value));
    
    document.getElementById('modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });
    
    window.addEventListener('resize', () => {
        Object.keys(ctx).forEach(id => {
            const c = document.getElementById(id);
            if (c) resizeC(c);
        });
    });
    
    // Initial slider values
    document.getElementById('ibgSlider').dispatchEvent(new Event('input'));
    
    loop();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>